/*
	 .oooooo..o               .       .    o8o                                  
	d8P'    `Y8             .o8     .o8    `"'                                  
	Y88bo.       .ooooo.  .o888oo .o888oo oooo  ooo. .oo.    .oooooooo  .oooo.o 
	 `"Y8888o.  d88' `88b   888     888   `888  `888P"Y88b  888' `88b  d88(  "8 
	     `"Y88b 888ooo888   888     888    888   888   888  888   888  `"Y88b.  
	oo     .d8P 888    .o   888 .   888 .  888   888   888  `88bod8P'  o.  )88b 
	8""88888P'  `Y8bod8P'   "888"   "888" o888o o888o o888o `8oooooo.  8""888P' 
	                                                        d"     YD           
	                                                        "Y88888P'           
*/
var wittycss = {
	clientId: "d43a901f7e2623f7e3bc",
	css: "",
	gist: null,
	html: "",
	editor: {
		setShowPrintMargin: false
	},
	recentProjects: 5,
	user: null,
	theme: "ace/theme/textmate"
};

var wittycssCode = {
	css: null,
	html: null,
	default: "css"
};

var settings = {
	//generated by http://online-generator.com/name-generator/project-name-generator.php
	projectNames: ["Helpless Vulture", "Rebel Eyelid", "Disappointed Aimless Weeknight", "Strong Endless Hammer", "Husky Hammer", "Pure Dinosaur", "Maroon Crystal", "Harsh Parachute", "Screaming Scorpion", "Liquid Eagle", "Scarlet Moose", "Lost Brave Xylophone", "Dreadful Sliding Lion", "Brutal Harp", "Rapid Neutron", "Postal Freaky", "Star Homeless", "Risky Alpha", "Meaningful Microphone", "Tidy Plastic", "Outstanding Insane Dog", "Shiny Emerald", "Brave Compass", "Rare Oyster", "Solid Lama", "Elastic Coffin", "Brave Postal", "Rare Pineapple", "Intense Doorstop", "Albatross Persistent", "Cosmic Aberrant", "Risky Gloomy Doorstop", "Intense Waterbird", "Eternal Wrench", "Lost Balcony", "Green Breeze", "Green Viper", "Olive Gloomy Panther", "Dreadful Winter", "Gloomy Drill", "Steady Cobra", "Nocturnal Dog", "Vital Serpent", "Western Toothbrush", "Torpedo Lucky", "Random Donut", "Winter Tidy", "Steep Windshield", "Alarm Tasty", "Rocky Yellow Foot", "Helpless Temple", "Proton White", "Forgotten Lucky Longitude", "Postal Helpless", "Finger Confidential", "Intensive Mountain", "Dancing Creek", "Lucky Warehouse", "Rusty Laser", "Insane Gamma", "Accidentally Tea", "Modern Eastern Door", "Red Beam", "Eastern Sledgehammer", "Red Waffle", "Straw Mountain", "Hollow Wild Venus", "Tidy Smoke", "Quality Venom", "Black Mustard", "Intensive Lion", "Timely Electron", "Knife Minimum", "Full Fist", "Raw Sound", "Helpless Alarm", "Late Navy Smoke", "Brown Doorstop", "Lost Waterbird", "Golden Scattered Omega", "Eternal Late Waterbird", "Tainted Space", "Cheerful Alarm", "Rich Wrench", "Fierce Electrical", "Alien Crystal", "Northernmost Viper", "Intensive Morning", "Everyday Eternal Parachute", "Solid Obscure", "Nervous Sun", "Moving Pottery", "Ghastly Poseidon", "Tasty Unique Balcony", "Oyster Random", "Surreal Yard", "Temporary Wrench", "Remote Official Galaxy", "Mysterious Mountain", "Steady Eyelid", "Meaningful Viper", "Morbid Tuna", "Boiling Beta", "Eternal Hideous Mustard", "Pink Viper", "Teal Zeus", "Dirty Obscure", "Abandoned Skunk", "Beta Rusty", "Next Artificial", "Early Eagle", "Needless Freaky Swallow", "Grotesque Foot", "Stony Crystal", "Eternal Screwdriver", "Golden Hammer", "Solid Avenue", "Accidentally Eastern", "Strong Tire", "Steady Moose", "Coffin Silly", "Scarlet Tuba", "Lucky Morning", "Eagle Tainted", "Eastern Dinosaur", "Moving Scarecrow", "Skilled Lion", "Frozen Essential Backpack", "Stony Empty Cat", "Arm Lonesome", "Supersonic Barbershop", "Steep Alpha", "Appropriate Roadrunner", "Tiger Rebel", "Epsilon Dirty", "Icy Street", "Homeless Weather", "Electron Steep", "Elastic Albatross", "Parachute Permanent", "Serious Star", "Next Strawberry Coffin", "Cold Viper", "White Scarecrow", "Intense Temple", "Comic Stormy", "Stormy Cosmic", "Flying Gamma", "Dancing Kangaroo", "Minimum Roadrunner", "Shiny Homeless Drill", "Coffin Mysterious", "Surreal Screwdriver", "Plastic Brutal", "Serious Summer", "Moose Reborn", "Dreadful Ivory Jupiter", "Discarded Backpack", "Lonesome Moose", "Lonesome Backpack", "Venom Silly", "Permanent Hammer", "Furious Skunk", "Dinosaur Vital"],
	projectTag: "/gist/" //how to find project ID in url
};

/*
	      .o.                             
	     .888.                            
	    .8"888.     oo.ooooo.  oo.ooooo.  
	   .8' `888.     888' `88b  888' `88b 
	  .88ooo8888.    888   888  888   888 
	 .8'     `888.   888   888  888   888 
	o88o     o8888o  888bod8P'  888bod8P' 
	                 888        888       
	                o888o      o888o      	                                      
*/
var app = {
	test: function(){
		console.log('merge');
	},
	/* ------------------------------------------------------------------------------------------
	 * INIT
	 * --------------------------------------------------------------------------------------- */
	init: function(){
		
		/* ------------------------------------------------------------------------------------------
		 * Get settings from localStorage
		 * --------------------------------------------------------------------------------------- */
		wittycss = $.extend( wittycss, JSON.parse( localStorage.getItem("wittycss") ) );

		$(window).trigger("wittycss");

		/* ------------------------------------------------------------------------------------------
		 * HASH
		 * --------------------------------------------------------------------------------------- */
		var hash = window.location.hash.substr(1);

		if( !hash ) {
			hash = window.location.hash = "edit";
		}

		app.updateLayout( hash );

		window.onhashchange = function(e) {
			var newHash = e.newURL.substr( e.newURL.indexOf("#")+1 );
			var oldHash = e.oldURL.substr( e.oldURL.indexOf("#")+1 );
			app.updateLayout( newHash, oldHash );			
		}

		/* ------------------------------------------------------------------------------------------
		 * Layout changers
		 * --------------------------------------------------------------------------------------- */
		
		$(".changelayout").click( function(e){
			app.updateLayout( $(this).attr("rel") );
		} );
		
		/* ------------------------------------------------------------------------------------------
		 * Is Gist Page
		 * --------------------------------------------------------------------------------------- */
		
		var gistID = window.location.pathname.substr( window.location.pathname.indexOf( settings.projectTag ) + settings.projectTag.length );

		if( gistID.length ) {
			wittycss.gistID = gistID;
			$(window).trigger("wittycss");
		} else { //homepage
			
		}

		/* ------------------------------------------------------------------------------------------
		 * Show user profile
		 * --------------------------------------------------------------------------------------- */
		if( wittycss.user )
			app.user.showProfile();

		app.editors.init();
		
	},
	
	/* ------------------------------------------------------------------------------------------
	 * Alerts
	 * --------------------------------------------------------------------------------------- */
	alert: function( data, responseText, errorThrown ) {
		/*
			closeable: boolean
			parentClass: String
			reportBug: true
			strong: String
			title: String
			buttons: either json or array
				button
					text: String
					class: String
					href: String
					onclick: function

		*/
		if( data.closeable )
			var closeBtn = $('<button type="button" class="close" data-dismiss="alert">Ã—</button>');

		var title = $("<h4>" + ( data.strong ? "<strong>" + data.strong + " </strong>" : "" ) + ( data.title ? data.title : "" ) + "</h4>");
		
		if( responseText || errorThrown || data.reportBug) {
			s = jQuery.extend({}, wittycss);
			if( s.access_token )
				s.access_token = true
			else
				s.access_token = false
			s.projectNames = true;
			s = escape(JSON.stringify(s));
			
			if( !data.buttons )
				data.buttons = {}

			data.buttons.bugBtn = {
				text: "Report a bug",
				href: "mailto:wittycss@gmail.com?Subject=Bug&Body=%0A%0A----%0A"
						+ "URL: " + window.location.href + "%0A"
						+ "responseText: " + ( responseText ? escape(JSON.stringify(responseText)) : "" ) + "%0A"
						+ "errorThrown: " + ( errorThrown ? escape(JSON.stringify(errorThrown)) : "" ) + "%0A"
						+ "data: " + s + "%0A%0A"
			}
		}

		if( data.buttons ) {
			var buttonContainer = $('<div class="buttons"></div>');
			$.each( data.buttons, function(k, v) {
				if( v.text )
					$('<a class="btn ' + ( v.class ? v.class: "" ) + '" href="' + ( v.href ? v.href : "#" ) + '">' + v.text + '</a>')
						.click( function(e){
							if(v.onclick)
								v.onclick(e);
						})
						.appendTo(buttonContainer);
			});
		}

		var alert = $('<div id="' + ( data.id ? data.id: "" ) + '" class="alert clearfix fade in generatedAlert ' + ( data.parentClass ? data.parentClass: "" ) + '">')
			.append(closeBtn ? closeBtn : null)
			.append(title)
			.append(buttonContainer ? buttonContainer : null)
			.appendTo("#alerts");
	},
	
	updateLayout: function( newHash, oldHash ){
		
		oldHash = oldHash || window.location.hash.substr(1);

		$("body")[0].className = $("body")[0].className.replace( "view-" + oldHash, '');
		$("body").addClass( "view-" + newHash );
		window.location.hash = newHash;

		$(".editor").each( function(e){
			try{
				app[ "ace" + $(this).attr("rel") ].resize() 
			} catch(err) {

			}
		} );

	},

	/* ------------------------------------------------------------------------------------------
	 * USER
	 * --------------------------------------------------------------------------------------- */
	user: {
		login: function() {
			if( wittycss.user ) {
				app.user.showProfile();
			} else {
				github.user.login();
			}
		},
		logout: function() {
			app.reset();
		},
		showProfile: function() {
			$("#btn-user").hide();
			
			$("#settings-profile")
				.removeClass("hide")
				.find("#avatar")
					.append("<img class='avatarimg' src='" + wittycss.user.avatar_url + "' alt='" + wittycss.user.login + "' width='37' />");

			console.log(wittycss.user);
		}
	},

	/* ------------------------------------------------------------------------------------------
	 * FILES
	 * --------------------------------------------------------------------------------------- */

	save: function() {
		if( wittycss.user ) {
			if( wittycss.gistID ) {
				//github.gist.save();
				console.log("SAVE");
			} else {
				//github.gist.new();
				console.log("NEW");
			}
		} else {
			$(window).bind( "userLoggedIn.newWaitLogin", github.gist.new );
			app.user.login();
		}
	},

	reset: function() {
		localStorage.removeItem("wittycss");
		localStorage.removeItem("wittycssCode");
		if( window.location.pathname !== "/" ) {
			window.location.href = "/"
		} else {
			window.location.reload();
		}
	},

	/* ------------------------------------------------------------------------------------------
	 * Editors
	 * --------------------------------------------------------------------------------------- */
	editors: {
		
		/* ------------------------------------------------------------------------------------------
		 * INIT
		 * --------------------------------------------------------------------------------------- */
		init: function() {
			wittycssCode = $.extend( wittycssCode, JSON.parse( localStorage.getItem("wittycssCode") ) );

			$.each(wittycssCode, function(k, v) {
				wittycssCode[k] = wittycssCode[k] ? wittycssCode[k] : wittycss[k]
			});

			$(window).trigger("wittycssCode");


			$("#editors .editor").each(function(i){
				mode = $(this).attr("rel");
				name = "ace" + mode;
				app[name] = ace.edit(name);
				app[name].setTheme( wittycss.theme );
				app[name].getSession().setMode("ace/mode/" + mode);
				app[name].setShowPrintMargin( wittycss.setShowPrintMargin );
				app[name].setValue( wittycssCode[mode], 1 );

				app[name].on("change", app.editors.change );
			});

			//put focus on the default editor
			app[ "ace" + wittycssCode.default].focus();

			$("body").addClass("loaded");
		},
		/* ------------------------------------------------------------------------------------------
		 * Change
		 * --------------------------------------------------------------------------------------- */
		change: function(e) {
			
			$(".editor").each(function(){
				var mode = $(this).attr("rel");
				wittycssCode[ mode ] = app[ "ace" + mode ].getValue();	
			});
			
			$(window).trigger("wittycssCode");
		},
		/* ------------------------------------------------------------------------------------------
		 * Switch to previous editor
		 * --------------------------------------------------------------------------------------- */
		prev: function() {
			var prevEditor = $(".ace_focus").prev();
			if( !prevEditor[0] ) {
				prevEditor = $(".ace_editor").last();
			}

			app[ "ace" + $(prevEditor).attr("rel") ].focus();
		},
		/* ------------------------------------------------------------------------------------------
		 * Switch to next editor
		 * --------------------------------------------------------------------------------------- */
		next: function() {
			
			var nextEditor = $(".ace_focus").next();
			if( !nextEditor[0] ) {
				nextEditor = $(".ace_editor").first();
			}

			app[ "ace" + $(nextEditor).attr("rel") ].focus();
		}
	}
};
app.init();

/*
	  .oooooo.    .o88o.  .o88o. oooo   o8o                        
	 d8P'  `Y8b   888 `"  888 `" `888   `"'                        
	888      888 o888oo  o888oo   888  oooo  ooo. .oo.    .ooooo.  
	888      888  888     888     888  `888  `888P"Y88b  d88' `88b 
	888      888  888     888     888   888   888   888  888ooo888 
	`88b    d88'  888     888     888   888   888   888  888    .o 
	 `Y8bood8P'  o888o   o888o   o888o o888o o888o o888o `Y8bod8P' 
*/
window.applicationCache.addEventListener('updateready', function(e){
	$("#newVersion .btn-primary").click(function(e){
		window.location.reload();
	});
	$("#newVersion").show();
});

/*
	ooooo                                      oooo   .oooooo..o     .                                                     
	`888'                                      `888  d8P'    `Y8   .o8                                                     
	 888          .ooooo.   .ooooo.   .oooo.    888  Y88bo.      .o888oo  .ooooo.  oooo d8b  .oooo.    .oooooooo  .ooooo.  
	 888         d88' `88b d88' `"Y8 `P  )88b   888   `"Y8888o.    888   d88' `88b `888""8P `P  )88b  888' `88b  d88' `88b 
	 888         888   888 888        .oP"888   888       `"Y88b   888   888   888  888      .oP"888  888   888  888ooo888 
	 888       o 888   888 888   .o8 d8(  888   888  oo     .d8P   888 . 888   888  888     d8(  888  `88bod8P'  888    .o 
	o888ooooood8 `Y8bod8P' `Y8bod8P' `Y888""8o o888o 8""88888P'    "888" `Y8bod8P' d888b    `Y888""8o `8oooooo.  `Y8bod8P' 
	                                                                                                  d"     YD            
	                                                                                                  "Y88888P'
*/
$(window).bind("wittycss", function(e){
	//wittycss object changed. Save it in localStorage
	localStorage.setItem("wittycss", JSON.stringify( wittycss ));
});

$(window).bind("wittycssCode", function(e){
	//wittycssCode object changed. Save it in localStorage
	localStorage.setItem("wittycssCode", JSON.stringify( wittycssCode ));
});

/*
	  .oooooo.     o8o      .   oooo                     .o8       
	 d8P'  `Y8b    `"'    .o8   `888                    "888       
	888           oooo  .o888oo  888 .oo.   oooo  oooo   888oooo.  
	888           `888    888    888P"Y88b  `888  `888   d88' `88b 
	888     ooooo  888    888    888   888   888   888   888   888 
	`88.    .88'   888    888 .  888   888   888   888   888   888 
	 `Y8bood8P'   o888o   "888" o888o o888o  `V88V"V8P'  `Y8bod8P' 
*/
var github = {
	
	/* ------------------------------------------------------------------------------------------
	 * GIST
	 * --------------------------------------------------------------------------------------- */
	
	gist: {
		get: function( gistID, callback ) {

		},
		getAll: function() {

		},
		new: function() {
			var description = "#wittycss " + $("#project-name").val();
		},
		save: function() {

		},
		fork: function() {

		}
	},
	
	/* ------------------------------------------------------------------------------------------
	 * USER
	 * --------------------------------------------------------------------------------------- */
	user: {
		get: function() {
			var request = {
				path: "/user",
				method: "GET",
				success: function( data ){
					wittycss.user = data;
					app.user.showProfile();
					$(window).trigger( "wittycss" );
					$(window).trigger( "userLoggedIn" );
				}
			};
			github.request( request );

		},
		login: function( data ) {

			console.log( data );

			if( !data ) {
				//if it's not a callback
				if( wittycss.access_a ) {
					if( !wittycss.user ) {
						github.user.get();
					}
				} else {
					githubLoginWindow = open('https://github.com' + 
						'/login/oauth/authorize' + 
						'?client_id=' + wittycss.clientId +
						'&scope=user,gist', 'githubLogin', 'width=960, height=600, left=' + (document.documentElement.offsetWidth - 960)/2 + ', top=0');
					githubLoginWindow.focus();
					
				}
			} else {
				wittycss.access_token = data;
				localStorage.setItem("wittycss", JSON.stringify( wittycss ));
				github.user.get();
			}
		}
	},

	/* ------------------------------------------------------------------------------------------
	 * REQUEST MAKER
	 * --------------------------------------------------------------------------------------- */
	request: function( request ) {

		$("#preloader")
			.removeClass("progress success error")
			.addClass("progress");

		$.ajax({
	        url: 'https://api.github.com' + request.path + ( request.noToken ? '' : ( '?access_token=' + wittycss.access_token ) ),
	        type: request.method,
	        dataType: request.dataType ? request.dataType : "json",
	        data: ( request.data ? JSON.stringify( request.data ) : '' ),
	        headers: {
				'Content-Type': 'application/json; charset=UTF-8'
			}
	    })
	    .success( function(data, textStatus ){
	    	//make the preloader green
	    	$("#preloader").toggleClass("progress success");
	    	if( request.success ) {
	    		request.success( data );
	    	}
	    })
		.error( function(jqXHR, textStatus, errorThrown){
			console.log( jqXHR, textStatus, errorThrown );

			$("#preloader").toggleClass("progress error");
			
			if( errorThrown == "Not Found" ) {
				//call the alert with the notFoundAlert object
				app.alert( request.notFoundAlert, jqXHR.responseText, errorThrown );
			} else {
				//call the alert with the errorAlert object
				app.alert( request.errorAlert, jqXHR.responseText, errorThrown );
			}
		});
	}
	
	
}